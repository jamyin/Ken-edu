<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ssic.education.common.mapper.AddressExMapper">

	<select id="validAddressRootExists" resultType="com.ssic.education.common.dto.AddressDto">
		select
		id,create_time as createTime,parent_id as pid,address_code as
		addressCode,last_update_time as lastUpdateTime,address_name as
		addressName
		from t_edu_address
		where stat=1 and parent_id ='' and proj_id= #{projId} and id not
		in(#{addressId}) ;
	</select>

	<select id="findCodeByLastCreateTime" resultType="com.ssic.education.common.dto.AddressDto">
		select
		id,create_time as createTime,parent_id as pid,address_code as
		addressCode,last_update_time as lastUpdateTime,address_name as
		addressName
		from t_edu_address
		where stat=1 and parent_id ='' order by
		create_time desc;
	</select>
	

  	<select id="queryAddressIdAndParentIds" resultType="com.ssic.education.common.dto.AddressDto">
  		SELECT t1.id as id,t1.address_name as addressName,t1.parent_id as parentId,t1.address_code as addressCode FROM t_edu_address t1 WHERE t1.parent_id = #{parentId};
  	</select>
  	
  	<select id="queryCityId" resultType="com.ssic.education.common.dto.AddressDto">
  		select t1.id as id from t_edu_address t1 where t1.address_code like #{cityId}"%" and t1.stat = 1;
  	</select>
	
	<select id="getAddressStatistic" resultType="com.ssic.education.common.dto.AddressStatistic">
  		select address.address_code as addressCode, address.address_name as addressName, 
		address.longitude as x, address.latitude as y, statistic.num as schoolNum 
		from (
			select address_code, address_name, longitude, latitude from t_edu_address address 
			where 
			 <if test="parentCode != null" >
		        parent_code = #{parentCode} and 
		     </if>
			stat = 1 
		) address 
		LEFT JOIN
		(
			select address.address_code, address.address_name, IFNULL(0,count(*)) num from t_edu_address address
			LEFT JOIN t_edu_school school on address.address_code = school.address_code 			
			<if test="level != null" >
		        and level = #{level} 
		    </if>
			and school.stat = 1
			where 
			 <if test="parentCode != null" >
		        parent_code = #{parentCode} and 
		     </if>
			address.stat = 1 
			group by address.address_code, address.address_name
		) statistic
		on address.address_code = statistic.address_code and address.address_name = statistic.address_name
  	</select>

</mapper>