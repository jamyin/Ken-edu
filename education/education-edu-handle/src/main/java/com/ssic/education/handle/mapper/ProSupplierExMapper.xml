<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.ssic.education.handle.mapper.ProSupplierExMapper">
	<resultMap id="BaseResultMap" type="com.ssic.educateion.common.dto.ProSupplierDto" >
	    <!--
	      WARNING - @mbggenerated
	      This element is automatically generated by MyBatis Generator, do not modify.
	      This element was generated on Thu May 26 19:23:18 CST 2016.
	    -->
	    <id column="id" property="id" jdbcType="VARCHAR" />
	    <result column="supplier_name" property="supplierName" jdbcType="VARCHAR" />
	    <result column="address" property="address" jdbcType="VARCHAR" />
	    <result column="provinces" property="provinces" jdbcType="VARCHAR" />
	    <result column="city" property="city" jdbcType="VARCHAR" />
	    <result column="area" property="area" jdbcType="VARCHAR" />
	    <result column="supplier_type" property="supplierType" jdbcType="INTEGER" />
	    <result column="business_license" property="businessLicense" jdbcType="VARCHAR" />
	    <result column="organization_code" property="organizationCode" jdbcType="VARCHAR" />
	    <result column="food_service_code" property="foodServiceCode" jdbcType="VARCHAR" />
	    <result column="food_service_code_date" property="foodServiceCodeDate" jdbcType="DATE" />
	    <result column="food_business_code" property="foodBusinessCode" jdbcType="VARCHAR" />
	    <result column="food_business_code_date" property="foodBusinessCodeDate" jdbcType="DATE" />
	    <result column="food_circulation_code" property="foodCirculationCode" jdbcType="VARCHAR" />
	    <result column="food_circulation_code_date" property="foodCirculationCodeDate" jdbcType="DATE" />
	    <result column="food_produce_code" property="foodProduceCode" jdbcType="VARCHAR" />
	    <result column="food_produce_code_date" property="foodProduceCodeDate" jdbcType="DATE" />
	    <result column="corporation" property="corporation" jdbcType="VARCHAR" />
	    <result column="id_card" property="idCard" jdbcType="VARCHAR" />
	    <result column="id_type" property="idType" jdbcType="VARCHAR" />
	    <result column="contact_way" property="contactWay" jdbcType="VARCHAR" />
	    <result column="longitude" property="longitude" jdbcType="VARCHAR" />
	    <result column="latitude" property="latitude" jdbcType="VARCHAR" />
	    <result column="reviewed" property="reviewed" jdbcType="TINYINT" />
	    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
	    <result column="last_update_time" property="lastUpdateTime" jdbcType="TIMESTAMP" />
	    <result column="stat" property="stat" jdbcType="INTEGER" />
	  </resultMap>
	<select id="searchSupplierListBySupplierId" resultMap="BaseResultMap">
		SELECT * FROM t_pro_supplier ps WHERE EXISTS 
		(
			SELECT * FROM `t_pro_supplier_receiver` psr WHERE  psr.`receiver_id`=#{supplierId} AND ps.`id` = psr.`supplier_id`
		) 
		AND ps.`supplier_type` = #{supplierType} 
		<if test="suppliName!=null">
			and ps.supplier_name like '%${suppliName}%'
		</if>
		<if test="limit!=null">
			limit #{limit}
		</if>
		
	</select>
	
	<select id="searchSchWareSuppListBySuppSchoolId" resultMap="BaseResultMap">
		SELECT * FROM t_pro_supplier ps WHERE EXISTS 
		(
			SELECT * FROM `t_pro_school_ware` psr WHERE  psr.`source_id`=#{supplierId} and psr.school_id = #{schoolId} AND ps.`id` = psr.`supplier_id`
		) 
		AND ps.`supplier_type` = #{supplierType} 
		<if test="suppliName!=null">
			and ps.supplier_name like '%${suppliName}%'
		</if>
		<if test="limit!=null">
			limit #{limit}
		</if>
		
	</select>	

	<select id="findSupplierIdByName" resultType="String">
		SELECT
		a.id
		FROM
		t_pro_supplier a
		WHERE
		a.supplier_name = #{supplierName}
	</select>

	<select id="findProSupplier"
		resultType="com.ssic.educateion.common.dto.SupplierDto">
		SELECT
		a.id,
		supplier_name supplierName,
		address,
		provinces,
		city,
		area,
		supplier_type supplierType,
		business_license businessLicense,
		organization_code organizationCode,
		food_service_code foodServiceCode,
		food_service_code_date foodServiceCodeDate,
		food_business_code
		foodBusinessCode,
		food_business_code_date foodBusinessCodeDate,
		food_circulation_code foodCirculationCode,
		food_circulation_code_date
		foodCirculationCodeDate,
		food_produce_code foodProduceCode,
		food_produce_code_date foodProduceCodeDate,	
		corporation,
		contact_way contactWay,
		longitude,
		latitude,		
		b.supplier_code  as  supplierCode
		FROM
			t_pro_supplier a  ,
			t_pro_supplier_receiver b
		WHERE
		stat = 1  AND
		
		b.supplier_id=a.id
		<include refid="where_findSupplier"></include>
		ORDER BY   a.create_time DESC
		<if test="ph!=null and ph.rows!=0">
			limit #{ph.beginRow},#{ph.rows}
		</if>
	</select>

	<select id="findSupplierDetail" resultType="com.ssic.educateion.common.dto.ProSupplierDto"
		parameterType="java.lang.String">
		SELECT
		a.id,a.supplier_name AS
		supplierName,a.address,a.provinces,a.city,a.area,a.supplier_type
		AS
		supplierType,a.business_license AS
		businessLicense,a.organization_code
		AS
		organizationCode,a.corporation,a.contact_way AS
		contactWay,a.longitude,a.latitude,a.create_time AS
		createTime,a.last_update_time AS lastUpdateTime,a.stat,
		b.lic_name AS
		licName,b.lic_no AS licNo,b.lic_type AS licType,b.lic_end_date AS
		licEndDate,b.lic_pic AS licPic
		FROM
		t_pro_supplier a
		LEFT JOIN
		t_pro_license b
		ON a.id = b.relation_id
		WHERE
		a.id = #{id} AND a.stat = 1
		AND b.stat = 1
		ORDER BY a.create_time DESC
	</select>
	<select id="findProSupplierById"
		resultType="com.ssic.educateion.common.dto.SupplierDto">
		SELECT

	a.id,
	a.supplier_name supplierName,
	a.address,
	a.provinces,
	a.city,
	a.area,
	a.supplier_type supplierType,
	a.business_license businessLicense,
	a.organization_code organizationCode,
	a.food_service_code foodServiceCode,
	a.food_service_code_date foodServiceCodeDate,
	a.food_business_code foodBusinessCode,
	a.food_business_code_date foodBusinessCodeDate,
	a.food_circulation_code foodCirculationCode,
	a.food_circulation_code_date foodCirculationCodeDate,
	a.food_produce_code foodProduceCode,
	a.food_produce_code_date foodProduceCodeDate,
	a.corporation,
	a.contact_way contactWay,
	a.longitude,
	a.latitude,
  b.supplier_code  AS supplierCode
FROM
	t_pro_supplier a,
t_pro_supplier_receiver b
WHERE
 b.supplier_id=#{id}
AND  a.stat=1 AND  a.id=#{id}
	</select>
	<sql id="where_findSupplier">
		<if test="supplierDto.supplierName!=null and  supplierDto.supplierName!=''">
			AND supplier_name like "%"#{supplierDto.supplierName}"%"
		</if>
		<if test="supplierDto.address!=null and supplierDto.address!='' ">
			AND address like "%"#{supplierDto.address}"%"
		</if>
		<if test="supplierDto.supplierType!=null and supplierDto.supplierType!='' ">
			AND supplier_type = #{supplierDto.supplierType}
		</if>
		<if test="supplierDto.receiverId!=null and supplierDto.receiverId!='' ">
			AND b.receiver_id=  #{supplierDto.receiverId}
		</if>
		
	</sql>

	<insert id="insert" parameterType="com.ssic.educateion.common.dto.SupplierDto">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Mon May 16 
			10:22:46 CST 2016. -->
		insert into t_pro_supplier (id, supplier_name, address,
		provinces, city, area,
		supplier_type, business_license, organization_code,
		food_service_code, food_service_code_date, food_business_code,
		food_business_code_date, food_circulation_code,
		food_circulation_code_date, food_produce_code,
		food_produce_code_date, 
		corporation, contact_way, longitude,
		latitude, create_time, last_update_time,
		stat)
		values (#{id,jdbcType=VARCHAR}, #{supplierName,jdbcType=VARCHAR},
		#{address,jdbcType=VARCHAR},
		#{provinces,jdbcType=VARCHAR}, #{city,jdbcType=VARCHAR}, #{area,jdbcType=VARCHAR},
		#{supplierType,jdbcType=INTEGER}, #{businessLicense,jdbcType=VARCHAR},
		#{organizationCode,jdbcType=VARCHAR},
		#{foodServiceCode,jdbcType=VARCHAR},
		#{foodServiceCodeDate,jdbcType=DATE},
		#{foodBusinessCode,jdbcType=VARCHAR},
		#{foodBusinessCodeDate,jdbcType=DATE},
		#{foodCirculationCode,jdbcType=VARCHAR},
		#{foodCirculationCodeDate,jdbcType=DATE},
		#{foodProduceCode,jdbcType=VARCHAR},
		#{foodProduceCodeDate,jdbcType=DATE}, #{code,jdbcType=VARCHAR},
	
		#{corporation,jdbcType=VARCHAR}, #{contactWay,jdbcType=VARCHAR}, #{longitude,jdbcType=VARCHAR},
		#{latitude,jdbcType=VARCHAR}, #{createTime,jdbcType=TIMESTAMP},
		#{lastUpdateTime,jdbcType=TIMESTAMP},
		#{stat,jdbcType=INTEGER})
	</insert>

	<update id="updateByPrimaryKeySelective" parameterType="com.ssic.educateion.common.dto.SupplierDto">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Mon May 16 
			10:22:46 CST 2016. -->
		update t_pro_supplier
		<set>
			<if test="supplierName != null">
				supplier_name = #{supplierName,jdbcType=VARCHAR},
			</if>
			<if test="address != null">
				address = #{address,jdbcType=VARCHAR},
			</if>
			<if test="provinces != null">
				provinces = #{provinces,jdbcType=VARCHAR},
			</if>
			<if test="city != null">
				city = #{city,jdbcType=VARCHAR},
			</if>
			<if test="area != null">
				area = #{area,jdbcType=VARCHAR},
			</if>
			<if test="supplierType != null">
				supplier_type = #{supplierType,jdbcType=INTEGER},
			</if>
			<if test="businessLicense != null">
				business_license = #{businessLicense,jdbcType=VARCHAR},
			</if>
			<if test="organizationCode != null">
				organization_code = #{organizationCode,jdbcType=VARCHAR},
			</if>
			<if test="foodServiceCode != null">
				food_service_code = #{foodServiceCode,jdbcType=VARCHAR},
			</if>
			<if test="foodServiceCodeDate != null">
				food_service_code_date =
				#{foodServiceCodeDate,jdbcType=DATE},
			</if>
			<if test="foodBusinessCode != null">
				food_business_code =
				#{foodBusinessCode,jdbcType=VARCHAR},
			</if>
			<if test="foodBusinessCodeDate != null">
				food_business_code_date =
				#{foodBusinessCodeDate,jdbcType=DATE},
			</if>
			<if test="foodCirculationCode != null">
				food_circulation_code =
				#{foodCirculationCode,jdbcType=VARCHAR},
			</if>
			<if test="foodCirculationCodeDate != null">
				food_circulation_code_date =
				#{foodCirculationCodeDate,jdbcType=DATE},
			</if>
			<if test="foodProduceCode != null">
				food_produce_code = #{foodProduceCode,jdbcType=VARCHAR},
			</if>
			<if test="foodProduceCodeDate != null">
				food_produce_code_date =
				#{foodProduceCodeDate,jdbcType=DATE},
			</if>
			
			
			<if test="corporation != null">
				corporation = #{corporation,jdbcType=VARCHAR},
			</if>
			<if test="contactWay != null">
				contact_way = #{contactWay,jdbcType=VARCHAR},
			</if>
			<if test="longitude != null">
				longitude = #{longitude,jdbcType=VARCHAR},
			</if>
			<if test="latitude != null">
				latitude = #{latitude,jdbcType=VARCHAR},
			</if>
			<if test="createTime != null">
				create_time = #{createTime,jdbcType=TIMESTAMP},
			</if>
			<if test="lastUpdateTime != null">
				last_update_time = #{lastUpdateTime,jdbcType=TIMESTAMP},
			</if>
			<if test="stat != null">
				stat = #{stat,jdbcType=INTEGER},
			</if>
		</set>
		where id = #{id,jdbcType=VARCHAR}
	</update>
	
	<select id="lookRelatingWares"  resultType="com.ssic.educateion.common.dto.ProSupplierDto"  parameterType="com.ssic.educateion.common.dto.ProSupplierDto">
	
					SELECT
				
					a.wares_name AS waresName,
				a.spec AS spec
				
				FROM
				
					t_pro_wares a
				WHERE
					a.supplier_id =#{dto.id} 
					AND
				a.way=0
				AND a.stat=1 

	</select>
	<select id="findSupplierCodeByReceiverId"
		resultType="com.ssic.educateion.common.dto.SupplierDto">
	
	
	SELECT
	a.supplier_code AS supplierCode
FROM
	t_pro_supplier_receiver a
WHERE
	a.receiver_id = #{supplierId}
	
	</select>
	
	<select id="findSupplierIdBySourceId" resultType="java.lang.String">
		SELECT b.id
		FROM t_pro_supplier_receiver a, t_pro_supplier b
		WHERE
		a.supplier_id=b.id
		AND a.receiver_id=#{ledgerDto.sourceId}
		AND
		b.supplier_name=#{ledgerDto.supplierName}
		AND b.stat = 1
	</select>
	 
	<select id="findSupplierListByCommittee" resultType="com.ssic.educateion.common.dto.ProSupplierDto" parameterType="com.ssic.educateion.common.dto.ProSupplierDto">
		SELECT
			a.id,
			a.supplier_name supplierName,
			a.address,
			a.provinces,
			a.city,
			a.area,
			a.supplier_type supplierType,
			a.business_license businessLicense,
			a.organization_code organizationCode,
			a.food_service_code foodServiceCode,
			a.food_service_code_date foodServiceCodeDate,
			a.food_business_code foodBusinessCode,
			a.food_business_code_date foodBusinessCodeDate,
			a.food_circulation_code foodCirculationCode,
			a.food_circulation_code_date foodCirculationCodeDate,
			a.food_produce_code foodProduceCode,
			a.food_produce_code_date foodProduceCodeDate,
			a.corporation,
			a.contact_way contactWay,
			a.id_card idCard,
			a.id_type idType,
			a.contact_way contactWay,
			a.reviewed,
			a.longitude,
			a.latitude,
			a.create_time createTime, 
      		a.last_update_time lastUpdateTime, 
      		a.stat,
		 	b.committee_id committeeId
			FROM t_pro_supplier a
			LEFT JOIN t_edu_supplier_review b ON a.id = b.supplier_id 
			WHERE a.stat=1 AND b.stat = 1
			<if test="proSupplierDto.committeeId!=null and proSupplierDto.committeeId!='' ">
				AND b.committee_id = #{proSupplierDto.committeeId}
			</if>
			<if test="proSupplierDto.reviewed!=null">
				AND a.reviewed = #{proSupplierDto.reviewed}
			</if>
			ORDER BY b.last_update_time desc,b.create_time desc
			<if test="query != null">
	       		LIMIT  #{query.startNum}, #{query.pageSize}
	        </if>
	</select>
	
	<select id="countSupplierListByCommittee" resultType="java.lang.Long" parameterType="com.ssic.educateion.common.dto.ProSupplierDto">
		SELECT count(*)
		FROM t_pro_supplier a
		LEFT JOIN t_edu_supplier_review b ON a.id = b.supplier_id 
		WHERE a.stat=1 AND b.stat = 1
		<if test="proSupplierDto.committeeId!=null and proSupplierDto.committeeId!='' ">
			AND b.committee_id = #{proSupplierDto.committeeId}
		</if>
		<if test="proSupplierDto.reviewed!=null">
			AND a.reviewed = #{proSupplierDto.reviewed}
		</if>
	</select>
	
	<select id="findSupplierListBySchoolId" resultType="com.ssic.educateion.common.dto.ProSupplierDto" parameterType="com.ssic.educateion.common.dto.ProSupplierDto">
		SELECT
			a.id,
			a.supplier_name supplierName,
			a.address,
			a.provinces,
			a.city,
			a.area,
			a.supplier_type supplierType,
			a.business_license businessLicense,
			a.organization_code organizationCode,
			a.food_service_code foodServiceCode,
			a.food_service_code_date foodServiceCodeDate,
			a.food_business_code foodBusinessCode,
			a.food_business_code_date foodBusinessCodeDate,
			a.food_circulation_code foodCirculationCode,
			a.food_circulation_code_date foodCirculationCodeDate,
			a.food_produce_code foodProduceCode,
			a.food_produce_code_date foodProduceCodeDate,
			a.corporation,
			a.contact_way contactWay,
			a.id_card idCard,
			a.id_type idType,
			a.contact_way contactWay,
			a.reviewed,
			a.longitude,
			a.latitude,
			a.create_time createTime, 
      		a.last_update_time lastUpdateTime, 
      		a.stat
			FROM t_pro_supplier_receiver c 
			LEFT JOIN t_pro_supplier a ON a.id = c.supplier_id 
			WHERE a.stat=1
			<if test="proSupplierDto.supplierName!=null and proSupplierDto.supplierName!='' ">
				AND a.supplier_name like "%"#{proSupplierDto.supplierName}"%"
			</if>
			<if test="proSupplierDto.id!=null and proSupplierDto.id!='' ">
				AND c.receiver_id = #{proSupplierDto.id}
			</if>
			ORDER BY a.create_time desc
			<if test="query != null">
	       		LIMIT  #{query.startNum}, #{query.pageSize}
	        </if>
	</select>
	
	<select id="countSupplierListBySchoolId" resultType="java.lang.Long" parameterType="com.ssic.educateion.common.dto.ProSupplierDto">
		SELECT count(*)
			FROM t_pro_supplier_receiver c 
			LEFT JOIN t_pro_supplier a ON a.id = c.supplier_id 
			WHERE a.stat=1
			<if test="proSupplierDto.supplierName!=null and proSupplierDto.supplierName!='' ">
				AND a.supplier_name like "%"#{proSupplierDto.supplierName}"%"
			</if>
			<if test="proSupplierDto.id!=null and proSupplierDto.id!='' ">
				AND c.receiver_id = #{proSupplierDto.id}
			</if>
	</select>
</mapper>
